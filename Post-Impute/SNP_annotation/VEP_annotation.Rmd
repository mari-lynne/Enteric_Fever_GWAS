---
title: "SNP Annotation"
author: "Mari Johnson"
date: "23/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = '~/GWAS_22/new_gwas/Post-imp/Merged/Assoc/')
```

### Aims

- Upload SNP list to SNPNexus/VEP
- Results in various annotation files
- Download snp annotation results as .txt files and read into R 
- For candidate gene analysis prioritise and filter SNPs with gtex tissue expression, coding snps etc.

Load Packages:
```{r Packages}
library(data.table)
library(tidylog)
library(dplyr)
library(stringr)
```


### Write nexus snp list
```{r write nexus snp list}

fcy_sig <- fread("T_fcy.txt")
fcar_sig <- fread("T_fcar.txt")
T_tophits <- fread("T_tophits.txt")

sigsnps <- rbind(fcar_sig, fcy_sig, T_tophits)#From assoc analysis

vep <- select(sigsnps, CHR, BP, REF, ALT)
vep <- mutate(vep, strand = rep(1, 111))
vep <- mutate(vep, Type = rep("Chromosome", 111))
vep <- select(vep, Type, CHR, BP, REF, ALT, strand) %>% mutate(BP_1 = BP+1)
#collapse ref alt by /

vep <- vep %>% mutate(refalt = str_c(REF, ALT, sep = "/"))
vep <- select(vep, CHR, BP, BP_1, refalt, strand)

vep$BP_2 <- vep$BP

vep2 <- select(vep, CHR, BP, BP_2, refalt, strand)

write.table(vep, "vep.txt", row.names = F, col.names = F, quote = F, sep = " ")
write.table(vep2, "vep2.txt", row.names = F, col.names = F, quote = F, sep = " ")

#Then need to find what these snps are in LD with
```

```{r Format Annotation data}

#Read in data
temp = list.files(pattern="*.txt")
myfiles = lapply(temp, fread)
#add names to files  - names(myfiles) <- temp
trim <- str_extract(temp, ".{4,}?")
names(myfiles) <- trim
#Unlist files
list2env((myfiles), envir = .GlobalEnv)

#ID file ####
ID <- gen_ #contains file of nearest gene to the snps
rm(gen_)

ID <- ID[,1:6]

#Predicted ensembl function ####
ense <- ense %>% dplyr::select(`Variation ID`, Variant, Symbol, `Predicted Function`) %>% distinct()

ense2 <- ense %>% filter(`Predicted Function` != "intronic")

#collapse by ID
ense2 <- ense %>%
  group_by(`Variation ID`, Variant, Symbol) %>%
  summarise(`Predicted Function` = toString(`Predicted Function`))

#Regulatory Elements ####

#reg elements downloaded from roadmap project via snpnexus 
str(road)
road$Epigenome <- as.factor(road$Epigenome)
levels(road$Epigenome)

#Contains many tissue eQTLs, #Filter for blood 
road2 <- road %>% filter(str_detect(road$Epigenome, "B cell|CD4|CD8|T cell|Monocyte|Neutrophil|myeloid|Natural Killer|Spleen"))

```

```{r gtEX, echo = FALSE}
#query for whole blood

```

```{r Joining tables}
#Join all of the annotation tables by their snp rs - Variation ID
#., allows you to pipe in previous table from left join
annote <- left_join(ense2, ID, by = "Variation ID") %>%
    left_join(.,cadd, by = "Variation ID") %>%
  left_join(., funs, by = "Variation ID") %>%
  select(-ends_with(".y")) %>% select(-ends_with(".x")) #clean names
gwas_hits <- left_join(gwas, annote, by ="Variation ID")
#chr1:161630802:A/G:1
```
### Results

##### FcGR Notes:
- Top SNP associated with enteric fever, chr1:161630802:A/G:1, has come out as significant for GWAS, reduces IgG levels in Iceland study
- In gtEX database it increases FcGR2B expression - which is an inhibitory receptor
- FcGR2B, is a Low affinity receptor. Involved in a variety of effector and regulatory functions such as phagocytosis of immune complexes and modulation of antibody production by B-cells. Binding to this receptor results in down-modulation of previous state of cell activation triggered via antigen receptors on B-cells (BCR), T-cells (TCR) or via another Fc receptor. Isoform IIB1 fails to mediate endocytosis or phagocytosis. Isoform IIB2 does not trigger phagocytosis.

#### FcaR notes

- Top Fcar snp associated with protection
- This snp  has been shown to increased kir expression whole blood, can recognise bacterial epitopes

### Next steps

- Plot annotation of snps using tracks
- Update fcgr, fcar, and top snps names in plink using an annotation file from snp nexus (eventually get sql query to work)
- Plot typhoid fever by genotype (find old scripts for this)
- Run eqtl analysis of top snps with gene expression following challenge