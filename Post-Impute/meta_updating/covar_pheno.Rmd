---
title: "Post-Impute"
author: "Mari Johnson"
date: "12/10/2022"
output: html_document
---

 Updates October:
 - Re-indexed and merged bcf files to get a more stringent R2
 - Making separate typhoid, para and merged plink files


```{r setup, include=FALSE, eval=TRUE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
knitr::opts_knit$set(root.dir = '~/GWAS_22/gwas_final/meta')
#Assoc folder switched to after merging
```
```{r Set up, eval=TRUE}
library(data.table)
library(stringr)
library(dplyr)
library(plinkQC)
library(tidylog)
library(janitor)
```

### Check Merge .fam IDs

```{r Tidy-fam-IID, eval = FALSE}
fam <- fread("merged_data.fam")
# Clean IID col to match ID in covar files
fam2 <- fam
fam2$V2 <-  str_remove_all(fam$V2, "^([0-9]+_)")
update_ids <- bind_cols(fam$V1, fam$V2, fam2$V1, fam2$V2)

write.table(update_ids, "update_ids.txt", col.names = F, row.names = F, quote = F, sep = '\t')
system("plink --bfile merged_data --update-ids update_ids.txt --make-bed --out merge_rn")
#TODO let plink2 know about error
```

#### Update covar and pheno files

**Key**
Strain: C, P = 3, T = 1, TN = 2
Sex M=1, F=2
Re-challenge N=1, PP=2, PT=3, TP=4, TT=5
Vaccine: NONE = 0, Ty21a = 1, M01ZH09= 2, Vi-PS = 3, Vi-TT= 4

```{r typhoid}
'%!in%' <- function(x,y)!('%in%'(x,y))
# covar checks -----------------------------------------------------------------
# New fam file -re filtered R2
fam <- fread("~/GWAS_22/gwas_final//merge/merge_rn.fam")
covar <- fread("~/GWAS_22/new_gwas/meta/final_metadata/all_covar_june.txt")
# Tidy covar table
covar$chall_vax <- str_c(covar$Challenge, covar$Vaccine, sep = "_")
covar <- clean_names(covar)
covar <- covar %>% dplyr::rename(IID = iid)

# Filter for serovars
covar_typhoid <- covar %>% filter(challenge != 3, re_challenge  != 5) #259
covar_para <- covar %>% filter(challenge == 3, re_challenge  != 2) #71
covar_enteric <- covar %>% filter(re_challenge == 1)  # 312
```

```{r check-missing}
# Check for missing samples ----------------------------------------------------
fam <- fam %>% rename(IID = V2)
new_covar <- left_join(fam, covar, by = "IID")
# missing samples
missing <- filter(new_covar, is.na(study))
# Make new IID col to match old IIDs 'Genotyping ID'
missing$IID_2 <- str_remove_all(missing$IID, "^([0-9]+-)")
```

```{r Tidy-missing}
 # Tidy old covar files---------------------------------------------------------
check <- fread("~/GWAS_22/new_gwas/meta/covar.txt")
#pheno2 <- fread("~/GWAS_22/new_gwas/meta/pheno.txt")
#covar2 <- left_join(pheno2, covar2, by ="GENOTYPING_ID")
#rm(pheno2)
check <- rename(check, IID = GENOTYPING_ID)
# Look in old covar for IIDs that are in our missing IIDs
check <- filter(check, IID %in% missing$IID_2)
check <-  distinct(check) %>% filter(!is.na(Study))
# Found 5 samples :) with diagnosis info

# Tidy colnames/vars so can rejoin----------------------------------------------
check$Vaccine <- ifelse(check$Vaccine == "None",0,
                            ifelse(check$Vaccine == "Ty21a",1,
                                   ifelse(check$Vaccine == "M01ZH09", 2,
                                          ifelse(check$Vaccine == "Vi-PS", 3,
                                                 ifelse(check$Vaccine == "Vi-TT", 4,NA)))))
#Recode strain, sex challenge
check$Challenge <- ifelse(check$Challenge == "P", 3, ifelse(check$Challenge == "T", 1, NA))
check$Sex <- ifelse(check$Sex == "M", 1, ifelse(check$Sex == "F", 2, NA))
check$Re_Challenge <- as.numeric(str_replace_all(check$Re_Challenge, "N", "1"))
check$Chall_Vax <- str_c(covar$Challenge, covar$Vaccine, sep = "_")
check <- clean_names(check)
check <- rename(check, IID_2 = iid) # will match IID_2 in missing then tidy
```
```{r Rejoin and remake tables}
# Rejoin -----------------------------------------------------------------------
missing <- missing %>% select(IID, IID_2)
missing <- left_join(missing, check, by = "IID_2") %>% filter(!is.na(study)) %>% select(-IID_2)

#add back to covar
covar <- bind_rows(covar, missing)
#check samples again
test <- anti_join(fam, covar, by = "IID") # 4 missing covars so improved :)

covar_typhoid <- covar %>% filter(challenge != 3, re_challenge  != 5) #263
covar_para <- covar %>% filter(challenge == 3, re_challenge  != 2) #72
covar_enteric <- covar %>% filter(re_challenge == 1)  #317
```

```{r Get-phenodata}
pheno <- fread("~/GWAS_22/new_gwas/meta/final_metadata/all_pheno_num.txt")
pheno <-  filter(pheno, IID %in% covar$IID) # 342

covar_typhoid <- left_join(covar_typhoid,pheno, by="IID")
covar_para <- left_join(covar_para,pheno, by="IID")
covar_enteric <- left_join(covar_enteric,pheno, by="IID")
```


```{r Extra PATCH samples}
# Check what fam IDs are in covar_typhoid
test <- filter(fam, IID %in% covar_typhoid$IID)# 255 #redo = 260 :)
# Check what covar_typhoid IIDs are not in test IIDs
patch <- filter(covar_typhoid, IID %!in% test$IID) 
# test <- filter(patch, IID %in% fam$IID) # 5 extra samples
# just need to remove _PATCH string from covar file so it will match fam IID

# Missex samples ---------------------------------------------------------------

missex <- fread("fail_sexcheck.txt")
missex <- missex[,V2]
covar_typhoid <- covar_typhoid %>% filter(IID %!in% missex)

# Make new tables
covar_typhoid$IID <- str_remove_all(covar_typhoid$IID, "_PATCH")
pheno_typhoid <- covar_typhoid %>% select(IID, Diagnosed)
keep_t <- inner_join(covar_typhoid, fam, by = "IID")

write.table(keep_t, file="keep_t.txt",col.names = F, row.names = F, quote = F, sep = '\t')
write.table(covar_typhoid, file="covar_typhoid.txt",col.names = T, row.names = F, quote = F, sep = '\t')
write.table(pheno_typhoid, file="pheno_typhoid", col.names = F, row.names = F, quote = F, sep = '\t')

#TODO paratyphoid files

```





Extra notes -------------------------------------------------------------------------

# Get current fam/IIDs of Missing samples
id <- filter(missing, IID_2 %in% covar2$GENOTYPING_ID)
id <- id 
id <- id %>% rename(FID = V1)

check <- left_join(check, id, by = "IID_2")
# Rearrange table
check <- check[,c(19,20,1:18)]

# Missing samples pheno file
check_pheno <- check %>% select(FID,IID,diagnosed)
check_covar <- check[,c(2,4:20)]

# Make keep file
keep_t <- inner_join(covar_typhoid, fam, by = "IID")
keep_t <- select(keep_t, V1, IID)



# 71 + 259 = 330, we have 315 participants, extra are included
# Amber had 103 + 96 = 209


# add to covar_enteric
check_covar$challenge <- as.integer(check_covar$challenge)
check_covar$re_challenge <- as.integer(check_covar$re_challenge)
covar_new <- bind_rows(covar_enteric, check_covar)
# left_join with old pheno files somehow
# Pheno updates
pheno_enteric <- covar_enteric[,c(1,5)]
pheno_typhoid <- covar_typhoid[,c(1,5)]
pheno_para <- covar_para[,c(1,5)]

# Recheck

fam_miss_covar <- fam[(fam$IID %!in% covar_enteric$IID),]
# Still missing 010, 047, 078, 087, 002
# zeros removed from IDs 

# Just need to rename covar file 
extra <- c("010", "047", "078", "087", "002") #did in excel bc i am tired
write.csv(covar, "covar.csv", row.names = F)
covar <- fread("covar.txt")

write.table(pheno_typhoid, "pheno_typhoid.txt", row.names = F, quote = F, sep = '\t')
write.table(pheno_para, "pheno_para.txt", row.names = F, quote = F, sep = '\t')
write.table(pheno_enteric, "pheno_enteric.txt", row.names = F, quote = F, sep = '\t')

# Then remake files from covar
# Make keep file
keep_t <- inner_join(covar_typhoid, fam, by = "IID")
keep_t <- select(keep_t, V1, IID)

keep_p <- inner_join(covar_para, fam, by = "IID")
miss <- anti_join(covar_para, fam, by = "IID") #some have patch IDs so need to get old ones
keep_p <- select(keep_p, V1, IID)

write.table(keep_t, file="keep_t.txt",col.names = F, row.names = F, quote = F, sep = '\t')
write.table(keep_p, file="keep_p.txt",col.names = F, row.names = F, quote = F, sep = '\t')

#files <- mget(ls())
#for (i in 1:length(files)){
#write.table(files[[i]], paste(names(files[i]), ".txt", sep = ""), row.names = F, quote = F, sep = '\t')}
# move to ~/GWAS_22/gwas_final/meta

covar$study <- as.factor(covar$study)
table(covar$study)
# Samples
#P1 PATCH    T1    T2 TYGER  VAST 
#50    36    38    80    40   102
```
#### Typhoid

```{bash filter typhoid}
plink2 --bfile merge_rn --keep keep_t.txt --make-bed --out typhoid
plink2 --bfile merge_rn --keep keep_p.txt --make-bed --out paratyphoid
```
#### Paratyphoid

#### All enteric


### PCA

```{r add in PCA to covar file}
setwd("~/GWAS_22/gwas_final/meta")
covar <- fread("covar_enteric.txt") # renamed extra <- c("010", "047", "078", "087", "002") 
covar_typhoid <- fread("covar_typhoid.txt") # 259 
keep_t <- fread("keep_t.txt") # 258
fam <- fread("~/GWAS_22/gwas_final/merge/QC/typhoid.IBD.fam") # 251
pca <- fread("~/GWAS_22/gwas_final/merge/QC/pca/typhoid.LD.eigenvec") # 251

fam <- fam %>% rename(IID = V2)
fam <- fam %>% rename(FID = V1)
pca <- pca %>% rename(FID = '#FID')
covar_pca <- left_join(pca, covar_typhoid, by = "IID")

# Make chall_vax character
covar_pca$chall_vax <- str_c(rep("_v",length(covar_pca$chall_vax)), covar_pca$chall_vax)
write.table(covar_pca, file = "covar_pca.txt", quote = F, row.names = F)

# Update pheno
pheno <- filter(pheno, IID %in% fam$IID)


```

