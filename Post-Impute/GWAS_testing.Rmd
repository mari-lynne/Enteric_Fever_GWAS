---
title: "GWAS_testing"
author: "Mari Johnson"
date: "16/03/2022"
output: html_document
---

### Introduction

In this document is code for running association tests using genotyping data in Plink\
Association testing is performed with plink and the results will be visualised using R\


### Aims

1.  Run association tests of enteric fever challenge data across all enteric fever studies - typhoid and paratyphoid combined
  - Visualise GWAS results using a Manhattan Plot
2. Associate the Fc receptor region SNPs with enteric fever
3. Run association tests for paratyphoid and typhoid separately 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = '~/GWAS_22/new_gwas/Post-imp/Merged/Assoc/')
```
Load Packages
```{r load, eval=TRUE}
library(data.table)
library(tidylog)
library(dplyr)
library(stringr)
library(qqman)
```
### GWAS

- Run enteric fever GWAS with PCA as covariates

```{bash GWAS}
plink2 --bfile all_enteric_QC2 --pheno all_pheno_num.txt --pheno-name Diagnosed --covar pca_covar.txt --covar-name Sex, Challenge, Dose, Vaccine, Age, Re_Challenge, PC1, PC2, PC3, PC4, PC5 --covar-variance-standardize --glm --out enteric_assoc
```

```{r Plot Assoc Results, eval = TRUE}

gwas <- fread("enteric_assoc.Diagnosed.glm.logistic.hybrid")

#rename cols for qqman
colnames(gwas) <- c("CHR", "BP", "SNP", "REF", "ALT", "A1","FIRTH?","TEST","OBS_CT","OR",        
                           "LOG(OR)_SE","Z_STAT","P","ERRCODE")

gwas$TEST <- as.factor(gwas$TEST)
gwas<- filter(gwas, TEST == "ADD") #Keep just genetic testing

#Plot Manhattan
manhattan(gwas, ylim = c(0, 8), cex = 0.6, cex.axis = 0.9, genomewideline = F, col = c("darkgrey", "skyblue"))

#Inspect top snps:

tophits <- filter(gwasResults, P < 10e-5)
head(tophits)
```
### FcyR Region

- Run association test just for FcyR SNPs on chromosome 1
```{bash FcYR assoc}
#Apply maf filter
#maf requires snps to be in 10% of population
plink2 --bfile all_enteric_QC --maf 0.1 --make-bed --out all_enteric_QC2
#4,942,013 variants remaining after main filters

#Make FcyR file
plink2 --bfile all_enteric_QC2 --chr 1 --from-bp 161505430 --to-bp 161678022 -make-bed --out fcyr

#Run Assoc
plink2 --bfile fcyr --pheno all_pheno_num.txt --pheno-name Diagnosed --covar pca_covar.txt --covar-name Sex, Challenge, Dose, Vaccine, Age, Re_Challenge, PC1, PC2, PC3, PC4, PC5 --covar-variance-standardize --glm --out fcy
```

```{r Plot Fcy Results, eval = TRUE}
gwasResults <- fread("fcy.Diagnosed.glm.logistic.hybrid")

colnames(gwasResults) <- c("CHR", "BP", "SNP", "REF", "ALT", "A1","FIRTH?","TEST","OBS_CT","OR",        "LOG(OR)_SE","Z_STAT","P","ERRCODE")

gwasResults$TEST <- as.factor(gwasResults$TEST)
gwasResults <- filter(gwasResults, TEST == "ADD")


#make character vector for Fcy
snpsOfInterest <- as.vector(gwasResults$SNP)

#Sig SNPs
fcy_sig <- filter(gwasResults, P <= 0.05)
head(fcy_sig)

```

### FcaR

- FcaR is on chromosome 19, run extra association analysis

```{bash FcaR assoc}
# +/- 10kb from gene co-oridnates chr19 54874231 --to-bp 54901420
plink2 --bfile all_enteric_QC2 fcar --pheno all_pheno_num.txt --pheno-name Diagnosed --covar pca_covar.txt --covar-name Sex, Challenge, Dose, Vaccine, Age, Re_Challenge, PC1, PC2, PC3, PC4, PC5 --covar-variance-standardize --glm --out fcar
```

```{r Plot Fcar Results, eval=TRUE}
fcarResults <- fread("fcar.Diagnosed.glm.logistic.hybrid")

colnames(fcarResults) <- c("CHR", "BP", "SNP", "REF", "ALT", "A1","FIRTH?","TEST","OBS_CT","OR",        
                           "LOG(OR)_SE","Z_STAT","P","ERRCODE")

fcarResults$TEST <- as.factor(fcarResults$TEST)
fcarResults <- filter(fcarResults, TEST == "ADD")

fcar_sig <- filter(fcarResults, P <= 0.05)
head(fcar_sig)
```

